files:
  "/etc/systemd/system/kafka_consumer.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Kafka Consumer Service
      After=network.target

      [Service]
      User=nobody
      Group=nobody
      WorkingDirectory=/var/app/current
      ExecStart=/bin/bash -c 'source /var/app/venv/*/bin/activate && python3 manage.py consume'
      EnvironmentFile=/opt/elasticbeanstalk/support/envvars
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

container_commands:
  01_install_jq:
    command: "yum install -y jq"
  02_create_envvars:
    command: 'mkdir -p /opt/elasticbeanstalk/support && /opt/elasticbeanstalk/bin/get-config environment | jq -r "to_entries | .[] | \"\(.key)=\(.value)\"" > /opt/elasticbeanstalk/support/envvars'
  03_reload_systemd:
    command: "systemctl daemon-reload"
  04_enable_kafka_consumer:
    command: "systemctl enable kafka_consumer.service"
  05_start_kafka_consumer:
    command: "systemctl start kafka_consumer.service"
